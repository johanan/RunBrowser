(function(a,b){a.appController=function(){this.mapView=null;this.runPath=null;this.watchid=null;this.mapPage=document.getElementById("mapPage");this.startPage=document.getElementById("startPage");this.showMapButton=document.getElementById("showMap");this.stop=document.getElementById("stop");this.saveButton=document.getElementById("saveRun");this.clearButton=document.getElementById("clearRun");this.backButton=document.getElementById("back");this.table=document.getElementById("savedRuns");this.errorModal=document.getElementById("errorModal");this.clearError=document.getElementById("clearError");this.saveModal=document.getElementById("saveModal");this.backdrop=document.getElementById("backdrop");this.addEvents=function(){var a=this;this.showMapButton.addEventListener("click",function(){a.showMap()});this.stop.addEventListener("click",function(){a.stopMap()});this.saveButton.addEventListener("click",function(){a.saveRun()});this.clearButton.addEventListener("click",function(){a.clearRun()});this.backButton.addEventListener("click",function(){a.clearRun()});this.clearError.addEventListener("click",function(){a.clearRun()})};this.saveRun=function(){localStorage.setItem(this.runPath.startTime,JSON.stringify(this.runPath));if(this.mapView!=null){this.mapView.destroy()}if(this.watchid!=null){navigator.geolocation.clearWatch(this.watchid);this.watchid=null}if(this.runPath!=null){this.runPath=null}b(this.backdrop).addClass("none");b(this.saveModal).addClass("none");b(this.mapPage).addClass("none");b(this.startPage).removeClass("none");this.showHome()};this.clearRun=function(){if(this.mapView!=null){this.mapView.destroy()}if(this.watchid!=null){navigator.geolocation.clearWatch(this.watchid);this.watchid=null}if(this.runPath!=null){this.runPath=null}b(this.backdrop).addClass("none");b(this.saveModal).addClass("none");b(this.errorModal).addClass("none");b(this.mapPage).addClass("none");b(this.startPage).removeClass("none")};this.showHome=function(){var a=this;b(this.table).removeClass("none");for(var c=this.table.rows.length;c>1;c--){this.table.deleteRow(c-1)}for(var d in localStorage){var e=JSON.parse(localStorage.getItem(d));var f=this.table.rows.length;var g=this.table.insertRow(f);var h=g.insertCell(0);var i=document.createElement("button");i.className="btn btn-danger";i.innerHTML='<i class="icon-remove icon-white"></i>';i.setAttribute("data-key",d);i.addEventListener("click",function(b){a.removeSavedRun(b.target)});h.appendChild(i);var j=g.insertCell(1);var k=new Date(e.startTime);var l=document.createTextNode(k.toDateString());j.appendChild(l);var m=g.insertCell(2);var n=document.createTextNode(Math.round(e.distance*100)/100);m.appendChild(n);var o=g.insertCell(3);var p=document.createElement("button");p.className="btn btn-inverse";p.innerHTML='<i class="icon-chevron-right icon-white"></i>';p.setAttribute("data-key",d);p.addEventListener("click",function(b){a.loadSavedRun(b.target)});o.appendChild(p)}if(this.table.rows.length==1){b(this.table).addClass("none")}};this.loadSavedRun=function(c){var d;if(c.getAttribute("data-key")){d=c.getAttribute("data-key")}else{d=c.parentNode.getAttribute("data-key")}var e=new a.runPath;var f=JSON.parse(localStorage.getItem(d));e.startTime=f.startTime;e.distance=f.distance;e.lastUpdateTime=f.lastUpdateTime;e.pointArray=f.pointArray;b(this.mapPage).removeClass("none");b(this.startPage).addClass("none");b(this.stop).addClass("none");b(this.backButton).removeClass("none");if(this.mapView!=null){this.mapView.destroy()}this.mapView=new a.mapView;for(var g=0;g<f.pointArray.length;g++){this.mapView.addPoint(f.pointArray[g])}this.mapView.updateTimeDistance(e.getElapsedFormat(),e.getDistance());this.mapView.updateSpeeds(e.getCurrentMph(),e.getMinMile())};this.removeSavedRun=function(a){var b;if(a.getAttribute("data-key")){b=a.getAttribute("data-key")}else{b=a.parentNode.getAttribute("data-key")}localStorage.removeItem(b);this.showHome()};this.errorHandler=function(a){b(this.backdrop).removeClass("none");b(this.errorModal).removeClass("none")};this.showMap=function(){b(this.mapPage).removeClass("none");b(this.startPage).addClass("none");b(this.stop).removeClass("none");b(this.backButton).addClass("none");if(this.mapView!=null){this.mapView.destroy()}this.mapView=new a.mapView;this.runPath=new a.runPath;var c=this;this.watchid=navigator.geolocation.watchPosition(function(a){c.GetLocation(a)},function(a){c.errorHandler(a)},{enableHighAccuracy:true,maximumAge:5e3,timeout:12e3});setTimeout(function(){window.scrollTo(0,0)},0)};this.stopMap=function(){b(this.backdrop).removeClass("none");b(this.saveModal).removeClass("none")};this.GetLocation=function(a){if(ptTest=this.runPath.addPoint(a)){this.mapView.addPoint(a);this.mapView.updateTimeDistance(this.runPath.getElapsedFormat(),this.runPath.getDistance());this.mapView.updateSpeeds(this.runPath.getCurrentMph(),this.runPath.getMinMile())}}};a.mapView=function(){this.map=new OpenLayers.Map("map");this.proj=new OpenLayers.Projection("EPSG:4326");this.line=new OpenLayers.Geometry.LineString([]);this.lineLayer=new OpenLayers.Layer.Vector("Line Layer");this.timeSpan=document.getElementById("time");this.distance=document.getElementById("distance");this.mph=document.getElementById("mph");this.minMile=document.getElementById("minMile");var a=new OpenLayers.Layer.OSM;this.map.addControl(new OpenLayers.Control.DrawFeature(this.lineLayer,OpenLayers.Handler.Path));var b={strokeColor:"#0000ff",strokeOpacity:.5,strokeWidth:5};var c=new OpenLayers.Feature.Vector(this.line,null,b);this.lineLayer.addFeatures([c]);this.map.addLayers([a,this.lineLayer]);this.map.zoomTo(15);this.updateTimeDistance=function(a,b){this.timeSpan.innerHTML=a;this.distance.innerHTML=b};this.updateSpeeds=function(a,b){this.mph.innerHTML=a;this.minMile.innerHTML=b}};a.mapView.prototype.addPoint=function(a){opLonLat=new OpenLayers.LonLat(a.coords.longitude,a.coords.latitude);opLonLat.transform(this.proj,this.map.getProjectionObject());point=new OpenLayers.Geometry.Point(opLonLat.lon,opLonLat.lat);this.line.addComponent(point);this.lineLayer.redraw();this.map.setCenter(opLonLat)};a.mapView.prototype.destroy=function(){this.map.destroy()};if(typeof Number.prototype.toRad==="undefined"){Number.prototype.toRad=function(){return this*Math.PI/180}}a.runPath=function(){this.distance=0,this.startTime=0,this.lastUpdateTime=0,this.pointArray=[],this.addPoint=function(a){if(a.coords.accuracy<=25&&a.timestamp-this.lastUpdateTime>=6e3||this.lastUpdateTime==0){var b=(new Date).getTime();this.pointArray.push(a);this.lastUpdateTime=b;if(this.startTime==0){this.startTime=b}if(this.pointArray.length>=2){var c=this.pointArray.length;this.distance+=this.computeDistance(this.pointArray[c-2],this.pointArray[c-1])}return a}return false},this.computeDistance=function(a,b){var c=a.coords.longitude;var d=b.coords.longitude;var e=a.coords.latitude;var f=b.coords.latitude;var g=3958.7558657440545;var h=(f-e).toRad();var i=(d-c).toRad();var e=e.toRad();var f=f.toRad();var j=Math.sin(h/2)*Math.sin(h/2)+Math.sin(i/2)*Math.sin(i/2)*Math.cos(e)*Math.cos(f);var k=2*Math.atan2(Math.sqrt(j),Math.sqrt(1-j));var l=g*k;return l},this.getDistance=function(){return this.distance.toPrecision(4)},this.getElapsed=function(){return(this.lastUpdateTime-this.startTime)/6e4},this.getElapsedFormat=function(){var a=this.lastUpdateTime-this.startTime;var b=Math.floor(a/1e3/60);a-=b*6e4;var c=Math.floor(a/1e3);c=(c<10?"0":"")+c;return b+":"+c},this.getCurrentMph=function(){return(this.pointArray[this.pointArray.length-1].coords.speed*2.23693629).toPrecision(4)},this.getMph=function(){return this.distance/(this.getElapsed()/60)},this.getMinMile=function(){var a=this.getElapsed()/this.distance;if(isNaN(a)){return 0}return a.toPrecision(4)}}})(window.RunBrowser=window.RunBrowser||{},window.Zepto)