/*! runBrowser - v - 2014-02-01
* Copyright (c) 2014 Joshua Johanan; Licensed  */
!function(a,b){a.appController=function(){this.mapView=null,this.runPath=null,this.watchid=null,this.timerid=null,this.startTime=null,this.mapPage=document.getElementById("mapPage"),this.startPage=document.getElementById("startPage"),this.showMapButton=document.getElementById("showMap"),this.stop=document.getElementById("stop"),this.saveButton=document.getElementById("saveRun"),this.clearButton=document.getElementById("clearRun"),this.backButton=document.getElementById("back"),this.table=document.getElementById("savedRuns"),this.errorModal=document.getElementById("errorModal"),this.clearError=document.getElementById("clearError"),this.saveModal=document.getElementById("saveModal"),this.backdrop=document.getElementById("backdrop"),this.init=function(){this.mapView=new a.mapView,navigator.geolocation.getCurrentPosition(this.mapView.centerMap.bind(this.mapView),function(){},{enableHighAccuracy:!0,maximumAge:5e3,timeout:6e3}),this.addEvents(),this.showHome()},this.addEvents=function(){var a=this;this.showMapButton.addEventListener("click",function(){a.showMap()}),this.stop.addEventListener("click",function(){a.stopMap()}),this.saveButton.addEventListener("click",function(){a.saveRun()}),this.clearButton.addEventListener("click",function(){a.clearRun()}),this.backButton.addEventListener("click",function(){a.clearRun()}),this.clearError.addEventListener("click",function(){a.clearRun()}),this.table.addEventListener("click",this.tableClick.bind(this))},this.saveRun=function(){localStorage.setItem(this.runPath.startTime,JSON.stringify(this.runPath)),this.mapView.destroy(),null!=this.watchid&&(navigator.geolocation.clearWatch(this.watchid),this.watchid=null),null!=this.runPath&&(this.runPath=null),b(this.backdrop).addClass("none"),b(this.saveModal).addClass("none"),b(this.mapPage).addClass("none"),b(this.startPage).removeClass("none"),this.showHome(),this.stopClock()},this.clearRun=function(){this.mapView.destroy(),null!=this.watchid&&(navigator.geolocation.clearWatch(this.watchid),this.watchid=null),null!=this.runPath&&(this.runPath=null),b(this.backdrop).addClass("none"),b(this.saveModal).addClass("none"),b(this.errorModal).addClass("none"),b(this.mapPage).addClass("none"),b(this.startPage).removeClass("none"),this.stopClock()},this.showHome=function(){b(this.table).removeClass("none");var a=this.table.rows.length-1,c=1;for(var d in localStorage){if(c>a){var e=JSON.parse(localStorage.getItem(d)),c=this.table.rows.length,f=this.table.insertRow(c),g=f.insertCell(0),h=document.createElement("button");h.className="btn btn-danger delete-run",h.innerText="Delete",h.setAttribute("data-key",d),g.appendChild(h);var i=f.insertCell(1),j=new Date(e.startTime),k=document.createTextNode(j.toDateString());i.appendChild(k);var l=f.insertCell(2),m=document.createTextNode(Math.round(100*e.distance)/100);l.appendChild(m);var n=f.insertCell(3),o=document.createElement("button");o.className="btn btn-inverse view-run",o.innerText="View",o.setAttribute("data-key",d),n.appendChild(o)}c++}1==this.table.rows.length&&b(this.table).addClass("none")},this.loadSavedRun=function(c){var d;d=c.getAttribute("data-key")?c.getAttribute("data-key"):c.parentNode.getAttribute("data-key");var e=new a.runPath,f=JSON.parse(localStorage.getItem(d));e.startTime=f.startTime,e.distance=f.distance,e.lastUpdateTime=f.lastUpdateTime,e.pointArray=f.pointArray,b(this.mapPage).removeClass("none"),b(this.startPage).addClass("none"),b(this.stop).addClass("none"),b(this.backButton).removeClass("none"),this.mapView.destroy();for(var g=0;g<f.pointArray.length;g++)this.mapView.addPoint(f.pointArray[g]);this.mapView.updateTimeDistance(e.getElapsedFormat(),e.getDistance()),this.mapView.updateSpeeds(e.getCurrentMph(),e.getMinMile())},this.removeSavedRun=function(a){var b;b=a.getAttribute("data-key")?a.getAttribute("data-key"):a.parentNode.getAttribute("data-key"),localStorage.removeItem(b),this.showHome()},this.errorHandler=function(){b(this.backdrop).removeClass("none"),b(this.errorModal).removeClass("none"),this.stopClock()},this.showMap=function(){b(this.mapPage).removeClass("none"),b(this.startPage).addClass("none"),b(this.stop).removeClass("none"),b(this.backButton).addClass("none"),null!=this.mapView&&this.mapView.destroy(),this.runPath=new a.runPath;var c=this;this.watchid=navigator.geolocation.watchPosition(function(a){c.GetLocation(a)},function(a){c.errorHandler(a)},{enableHighAccuracy:!0,maximumAge:6e3,timeout:12e3}),this.startClock()},this.stopMap=function(){b(this.backdrop).removeClass("none"),b(this.saveModal).removeClass("none")},this.GetLocation=function(a){(ptTest=this.runPath.addPoint(a))&&(this.mapView.addPoint(a),this.mapView.updateSpeeds(this.runPath.getCurrentMph(),this.runPath.getMinMile()),this.mapView.updateDistance(this.runPath.getDistance()))},this.tableClick=function(a){var c=b(a.target);"BUTTON"===c[0].tagName&&c.hasClass("delete-run")?(this.removeSavedRun(a.target),c.parent().parent().remove()):"BUTTON"===c[0].tagName&&c.hasClass("view-run")&&this.loadSavedRun(a.target)},this.startClock=function(){this.stopClock(),this.startTime=(new Date).getTime(),this.timerid=setInterval(function(){this.mapView.updateTime((new Date).getTime()-this.startTime)}.bind(this),1e3)},this.stopClock=function(){null!==this.timerid&&(clearInterval(this.timerid),this.timerid=null)},this.init()},a.mapView=function(){this.map=new L.Map("map",{zoomControl:!1});var a=new L.StamenTileLayer("watercolor");this.map.addLayer(a),this.line=L.polyline([],{color:"red"}).addTo(this.map),this.timeSpan=document.getElementById("time"),this.distance=document.getElementById("distance"),this.mph=document.getElementById("mph"),this.minMile=document.getElementById("minMile"),this.updateDistance=function(a){this.distance.innerHTML=a},this.updateTime=function(a){this.timeSpan.innerHTML=this.getElapsedFormat(a)},this.updateSpeeds=function(a,b){this.mph.innerHTML=a,this.minMile.innerHTML=b},this.getElapsedFormat=function(a){var b=Math.floor(a/1e3/60);a-=6e4*b;var c=Math.floor(a/1e3);return c=(10>c?"0":"")+c,b+":"+c}},a.mapView.prototype.addPoint=function(a){var b=new L.LatLng(a.coords.latitude,a.coords.longitude);this.map.setView(b),this.line.addLatLng(b)},a.mapView.prototype.destroy=function(){this.map.removeLayer(this.line),this.line=L.polyline([],{color:"red"}).addTo(this.map)},a.mapView.prototype.centerMap=function(a){var b=new L.LatLng(a.coords.latitude,a.coords.longitude);this.map.setView(b,15)},"undefined"==typeof Number.prototype.toRad&&(Number.prototype.toRad=function(){return this*Math.PI/180}),a.runPath=function(){this.distance=0,this.startTime=(new Date).getTime(),this.lastUpdateTime=0,this.pointArray=[],this.addPoint=function(a){if(a.coords.accuracy<=25&&a.timestamp-this.lastUpdateTime>=6e3||0==this.lastUpdateTime){var b=(new Date).getTime();if(this.pointArray.push(a),this.lastUpdateTime=b,this.pointArray.length>=2){var c=this.pointArray.length;this.distance+=this.computeDistance(this.pointArray[c-2],this.pointArray[c-1])}return a}return!1},this.computeDistance=function(a,b){var c=a.coords.longitude,d=b.coords.longitude,e=a.coords.latitude,f=b.coords.latitude,g=3958.7558657440545,h=(f-e).toRad(),i=(d-c).toRad(),e=e.toRad(),f=f.toRad(),j=Math.sin(h/2)*Math.sin(h/2)+Math.sin(i/2)*Math.sin(i/2)*Math.cos(e)*Math.cos(f),k=2*Math.atan2(Math.sqrt(j),Math.sqrt(1-j)),l=g*k;return l},this.getDistance=function(){return this.distance.toPrecision(3)},this.getElapsed=function(){return((new Date).getTime()-this.startTime)/6e4},this.getCurrentMph=function(){return(2.23693629*this.pointArray[this.pointArray.length-1].coords.speed).toPrecision(3)},this.getMph=function(){return this.distance/(this.getElapsed()/60)},this.getMinMile=function(){var a=this.getElapsed()/this.distance;return isNaN(a)?0:a.toPrecision(3)}}}(window.RunBrowser=window.RunBrowser||{},window.Zepto);